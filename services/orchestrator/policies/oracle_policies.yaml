# Oracle Decision Engine Policies
# Defines thresholds, constraints, and rules for automated decision making

# Policy metadata
metadata:
  name: oracle_decision_policies
  version: "1.0.0"
  last_updated: "2025-01-27"
  description: "Comprehensive policies for Oracle-driven system optimization"

# Global settings
global:
  # Safety constraints
  max_mutations_per_hour: 10
  max_concurrent_mutations: 3
  cooldown_period_minutes: 30
  
  # Confidence and evidence requirements
  min_confidence_threshold: 0.7
  min_evidence_count: 10
  min_time_window_hours: 2
  
  # Risk management
  max_risk_score: 8
  require_approval_above_risk: 6
  emergency_rollback_threshold: 9

# Decision thresholds by category
thresholds:
  
  # Performance optimization triggers
  performance:
    response_time:
      warning_threshold_ms: 1500
      critical_threshold_ms: 3000
      improvement_target_percent: 20
      
    success_rate:
      warning_threshold: 0.85
      critical_threshold: 0.70
      improvement_target: 0.95
      
    memory_usage:
      warning_threshold_mb: 2048
      critical_threshold_mb: 4096
      optimization_target_mb: 1536
      
    cpu_usage:
      warning_threshold_percent: 70
      critical_threshold_percent: 90
      optimization_target_percent: 50
  
  # User satisfaction triggers
  satisfaction:
    rating:
      warning_threshold: 3.5
      critical_threshold: 2.5
      target_rating: 4.5
      
    complaint_rate:
      warning_threshold: 0.1  # 10% of interactions
      critical_threshold: 0.2
      target_rate: 0.02
      
    feedback_sentiment:
      negative_threshold: 0.3
      critical_threshold: 0.5
      target_positive: 0.8
  
  # Usage and load balancing
  utilization:
    agent_dominance_threshold: 0.6  # One agent >60% usage
    underutilization_threshold: 0.05  # Agent <5% usage
    load_imbalance_threshold: 0.3  # 30% deviation from average
    
    traffic_distribution:
      max_single_agent_percent: 40
      min_agent_usage_percent: 5
      target_distribution: "even"

# Action policies - what mutations are allowed under what conditions
actions:
  
  # Prompt optimization
  prompt_patch:
    enabled: true
    risk_level: low
    approval_required: false
    
    triggers:
      - "user_satisfaction < thresholds.satisfaction.rating.warning_threshold"
      - "response_quality_score < 0.7"
      - "topic_drift_detected == true"
      
    constraints:
      max_patches_per_agent_per_day: 3
      max_patch_size_chars: 1000
      require_ab_testing: true
      
    safety_checks:
      - policy_validation
      - regression_test
      
  # Model routing changes  
  model_swap:
    enabled: true
    risk_level: high
    approval_required: true
    
    triggers:
      - "response_time > thresholds.performance.response_time.critical_threshold_ms"
      - "model_performance_degradation > 0.3"
      - "cost_optimization_potential > 0.2"
      
    constraints:
      max_swaps_per_day: 2
      require_canary_deployment: true
      rollback_plan_required: true
      
    safety_checks:
      - policy_validation
      - regression_test
      - performance_check
      - canary_deployment
      
  # LoRA adapter management
  lora_apply:
    enabled: true
    risk_level: high  
    approval_required: true
    
    triggers:
      - "persistent_user_dissatisfaction == true"
      - "domain_specific_improvement_needed == true"
      - "fine_tuning_data_available == true"
      
    constraints:
      max_lora_adapters_per_agent: 2
      require_validation_dataset: true
      min_training_examples: 100
      
    safety_checks:
      - policy_validation
      - regression_test
      - performance_check
      - security_scan
      
  lora_remove:
    enabled: true
    risk_level: medium
    approval_required: false
    
    triggers:
      - "lora_performance_degradation > 0.1"
      - "lora_adapter_conflict_detected == true"
      - "manual_removal_requested == true"
      
  # Parameter adjustments
  param_set:
    enabled: true
    risk_level: medium
    approval_required: false
    
    allowed_parameters:
      - "max_response_length"
      - "temperature"
      - "top_p"
      - "timeout_seconds"
      - "retry_attempts"
      
    forbidden_parameters:
      - "api_keys"
      - "secrets"
      - "security_settings"
      - "rate_limits"
      
    constraints:
      max_param_changes_per_hour: 5
      require_rollback_plan: true
      
  # Memory and context management
  memory_update:
    enabled: true
    risk_level: low
    approval_required: false
    
    operations:
      - "context_pruning"
      - "memory_consolidation" 
      - "relevance_scoring"
      - "history_compression"
      
    constraints:
      max_context_size_tokens: 16000
      min_context_retention_turns: 3
      preserve_system_context: true
      
  # Traffic routing changes
  route_change:
    enabled: true
    risk_level: medium
    approval_required: false
    
    triggers:
      - "load_imbalance > thresholds.utilization.load_imbalance_threshold"
      - "agent_performance_difference > 0.2"
      - "capacity_optimization_needed == true"
      
    constraints:
      max_traffic_shift_percent: 20
      gradual_rollout_required: true
      monitoring_duration_minutes: 60
      
  # Feature toggles
  feature_toggle:
    enabled: true
    risk_level: low
    approval_required: false
    
    allowed_features:
      - "enhanced_explanation_mode"
      - "debug_output"
      - "verbose_responses"
      - "context_awareness"
      
    constraints:
      max_feature_changes_per_day: 10
      require_impact_monitoring: true

# Safety and rollback policies
safety:
  
  # Automatic rollback triggers
  auto_rollback:
    enabled: true
    triggers:
      - "error_rate > 0.15"  # 15% error rate
      - "response_time > 10000"  # 10 second responses
      - "user_complaints > 5"  # 5 complaints in 10 minutes
      - "system_health_score < 0.5"
      
    conditions:
      max_rollback_time_minutes: 5
      verify_rollback_success: true
      alert_on_rollback_failure: true
      
  # Manual approval requirements
  approval_required:
    conditions:
      - "risk_score > global.require_approval_above_risk"
      - "action_type in ['model_swap', 'lora_apply']"
      - "affects_critical_agents == true"
      - "cross_system_impact == true"
      
    approvers:
      - "engineering_leads"
      - "ml_engineers" 
      - "operations_team"
      
    approval_timeout_hours: 24
    auto_reject_on_timeout: true
    
  # Emergency procedures
  emergency:
    triggers:
      - "security_incident == true"
      - "data_breach_detected == true"
      - "system_wide_failure == true"
      - "manual_emergency_declared == true"
      
    actions:
      - "halt_all_mutations"
      - "rollback_recent_changes"
      - "enable_safe_mode"
      - "notify_incident_response"
      
    recovery:
      require_manual_approval: true
      full_system_validation: true
      staged_recovery: true

# Monitoring and alerting policies
monitoring:
  
  # Key performance indicators
  kpis:
    optimization_success_rate:
      target: 0.8
      warning_threshold: 0.6
      
    false_positive_rate:
      target: 0.1
      warning_threshold: 0.2
      
    time_to_optimization:
      target_minutes: 30
      warning_threshold_minutes: 60
      
    rollback_rate:
      target: 0.05
      warning_threshold: 0.15
      
  # Alert conditions
  alerts:
    high_priority:
      - "repeated_rollbacks > 3 per hour"
      - "approval_queue_backlog > 10"
      - "safety_violations > 5 per day"
      
    medium_priority:
      - "optimization_success_rate < target"
      - "unusual_pattern_detected == true"
      - "resource_utilization > 90%"
      
    low_priority:
      - "policy_violations > 2 per day"
      - "recommendation_accuracy < 0.8"
      - "user_feedback_sentiment declining"

# Learning and adaptation policies
learning:
  
  # Model improvement
  model_updates:
    frequency: weekly
    triggers:
      - "success_rate_improvement > 0.1"
      - "pattern_detection_accuracy < 0.7"
      - "new_failure_modes_detected == true"
      
    validation:
      require_ab_testing: true
      min_test_duration_days: 7
      significance_level: 0.05
      
  # Policy adaptation
  policy_updates:
    frequency: monthly
    conditions:
      - "false_positive_rate > target"
      - "optimization_effectiveness < target"
      - "new_use_cases_identified == true"
      
    approval_process:
      require_review: true
      reviewers: ["policy_committee", "engineering_leads"]
      trial_period_days: 30
      
  # Threshold adjustments
  threshold_tuning:
    frequency: weekly
    method: "statistical_optimization"
    
    optimization_targets:
      - "minimize_false_positives"
      - "maximize_optimization_impact"
      - "balance_automation_vs_safety"
      
    constraints:
      max_change_percent: 10
      require_validation: true
      gradual_adjustment: true

# Compliance and governance
compliance:
  
  # Data handling
  data_governance:
    retention_period_days: 90
    anonymization_required: true
    encryption_at_rest: true
    audit_trail_required: true
    
  # Change management
  change_control:
    require_documentation: true
    approval_workflow: true
    rollback_plan_mandatory: true
    post_change_review: true
    
  # Risk management
  risk_assessment:
    mandatory_for_high_risk: true
    review_frequency_days: 30
    stakeholder_notification: true
    
# Environment-specific overrides
environments:
  
  development:
    global:
      max_mutations_per_hour: 100  # More relaxed for testing
      min_confidence_threshold: 0.5
      require_approval_above_risk: 8
      
    safety:
      auto_rollback:
        enabled: true
      approval_required:
        approval_timeout_hours: 1  # Faster approval for dev
        
  staging:
    # Inherits from global with some relaxations
    global:
      max_mutations_per_hour: 20
      
  production:
    # Most restrictive settings
    global:
      max_mutations_per_hour: 5
      min_confidence_threshold: 0.8
      require_approval_above_risk: 5
      
    safety:
      approval_required:
        approval_timeout_hours: 48  # Longer approval window
        auto_reject_on_timeout: true

# Integration settings
integrations:
  
  # External systems
  external_apis:
    rate_limits:
      openai: 1000  # requests per hour
      anthropic: 500
      monitoring: 10000
      
    timeouts:
      default_seconds: 30
      model_inference_seconds: 60
      
  # Notification systems
  notifications:
    slack:
      channels:
        alerts: "#liquid-hive-alerts"
        reports: "#liquid-hive-reports"
        approvals: "#liquid-hive-approvals"
        
    email:
      distribution_lists:
        engineering: "eng-team@company.com"
        operations: "ops-team@company.com"
        executives: "exec-team@company.com"